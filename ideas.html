<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Initiative</title>
</head>
<body>

<div class="container mt-5">
  <h1 class="mb-4">Community Initiative</h1>

  <!-- Idea Submission Form -->
  <form id="ideaForm">
    <div class="form-group">
      <label for="ideaInput">Submit your idea:</label>
      <input type="text" class="form-control" id="ideaInput" placeholder="Enter your idea">
    </div>
    <button type="submit" id="submitIdeaBtn">Submit</button>
  </form>

  <!-- Idea Gallery -->
  <div id="ideaGallery" class="mt-5">
    <!-- Ideas will be dynamically added here -->
  </div>
</div>

<footer class="footer mt-5">
  <div class="container">
    <p>Version 1.0</p>
  </div>
</footer>

<script type="module">
  // Firebase configuration
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js";
  import { getDatabase, ref, push, set, update, increment, get } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDn0L5eNhnsCkoNIl1xqXC1vAc9RgD3fxQ",
    authDomain: "camaswalkcommunity-e51e0.firebaseapp.com",
    projectId: "camaswalkcommunity-e51e0",
    storageBucket: "camaswalkcommunity-e51e0.appspot.com",
    messagingSenderId: "761814884837",
    appId: "1:761814884837:web:833d652b181df6e118cf0c",
    measurementId: "G-XQ35VWDWFD"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase();

  // Function to handle voting for an idea
  function voteForIdea(ideaId, userId) {
    const ideaRef = ref(database, `ideas/${ideaId}`);
    const likedByRef = ref(ideaRef, 'likedBy');

    // Check if the user has already voted for this idea
    get(likedByRef).then((snapshot) => {
      const likedBy = snapshot.val() || [];
      if (!likedBy.includes(userId)) { // If user hasn't already voted
        update(ideaRef, {
          votes: increment(1),
          likedBy: [...likedBy, userId] // Add user to likedBy array
        });
      } else {
        console.log("You have already voted for this idea.");
      }
    }).catch((error) => {
      console.error("Error checking likedBy array:", error);
    });
  }

  // Function to display ideas
  function displayIdeas() {
    const ideaGallery = document.getElementById('ideaGallery');
    ideaGallery.innerHTML = ''; // Clear previous ideas

    // Reference to the "ideas" node
    const ideasRef = ref(database, 'ideas');

    // Retrieve and display ideas
    get(ideasRef).then((snapshot) => {
      const ideas = snapshot.val();
      if (ideas) {
        Object.entries(ideas).forEach(([ideaId, idea]) => {
          const ideaCard = document.createElement('div');
          ideaCard.classList.add('idea-card');
          ideaCard.innerHTML = `
            <p>${idea.text}</p>
            <p>Submitted by: ${idea.displayName}</p>
            <p>Votes: ${idea.votes}</p>
            <button class="vote-btn" data-idea-id="${ideaId}">Vote</button>
          `;
          ideaCard.querySelector('.vote-btn').addEventListener('click', () => {
            const user = auth.currentUser;
            if (user) {
              const userId = user.uid;
              voteForIdea(ideaId, userId);
            } else {
              console.log("You need to be logged in to vote.");
            }
          });
          ideaGallery.appendChild(ideaCard);
        });
      } else {
        console.log("No ideas found.");
      }
    }).catch((error) => {
      console.error("Error retrieving ideas:", error);
    });
  }

  // Function to handle idea submission
  document.getElementById('ideaForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent form submission

    const ideaText = document.getElementById('ideaInput').value.trim(); // Get idea text
    if (ideaText !== '') {
      const user = auth.currentUser;
      if (user) {
        const userId = user.uid;
        submitIdea(ideaText, userId);
      } else {
        console.log("You need to be logged in to submit an idea.");
      }

      document.getElementById('ideaInput').value = ''; // Clear input field
    }
  });

  // Function to submit an idea to Firebase Realtime Database
  function submitIdea(ideaText, userId) {
    const ideasRef = ref(database, 'ideas'); // Reference to the "ideas" node
    const newIdeaRef = push(ideasRef); // Generate a unique key for the new idea
    set(newIdeaRef, { // Set the data for the new idea
      text: ideaText,
      displayName: userId, // Assuming you store the user's display name as the UID
      votes: 0,
      likedBy: [] // Initialize likedBy array
    }).then(() => {
      console.log("Idea submitted successfully.");
      displayIdeas(); // Refresh idea gallery after submission
    }).catch((error) => {
      console.error("Error submitting idea:", error);
    });
  }

  // Check if the user has already submitted an idea
  function hasUserSubmittedIdea(userId) {
    const ideasRef = ref(database, 'ideas');
    return get(ideasRef).then((snapshot) => {
      const ideas = snapshot.val();
      if (ideas) {
        return Object.values(ideas).some(idea => idea.displayName === userId);
      } else {
        return false;
      }
    }).catch((error) => {
      console.error("Error checking if user has submitted an idea:", error);
      return false;
    });
  }

  // Check if the user has already submitted an idea
  const user = auth.currentUser;
  if (user) {
    const userId = user.uid;
    hasUserSubmittedIdea(userId).then((hasSubmitted) => {
      if (!hasSubmitted) {
        // Enable idea submission form
        document.getElementById('submitIdeaBtn').disabled = false;
      } else {
        console.log("You have already submitted an idea.");
        // Disable idea submission form
        document.getElementById('submitIdeaBtn').disabled = true;
      }
    }).catch((error) => {
      console.error("Error checking if user has submitted an idea:", error);
    });
  }
  
  // Display initial set of ideas
  displayIdeas();
</script>

</body>
</html>
